> Роль это набор правил и переменных, которые будут запускаться и выполняться на серверах. В ролях мы описываем автоматизацию, откуда что скачать, какие шаблоны подкинуть, какие команды запустить и т.п. 

> Всё то, что ты обычно делаешь руками, теперь переносим в роли. Пусть машины работают. 

> У тестировщиков есть тест-кейсы, а у нас роли и плейбуки.


1. **создал роль** common 
   
   ansible-galaxy init common
   так же папки  можно в создать ручную. 

   Папки находящиеся в ролях:

   1. defaults —  папка содержит yml файлы с переменными по умолчанию. То есть в этих файлах задаются параметры, версии установочного софта, размер свопа и т.п. Все эти параметры можно переопределить из самого проекта.

   2. handlers — обработчики, которые выполняются в том случае, если они вызываются другими задачами. Например после установки nginx, нужно перезапустить сервис, на помощь придет обработчик.

   3. tasks — основная логика всей автоматизации, здесь и происходит магия.

   4. templates — шаблоны конфигов и прочего, например конфиг nginx который нужно раскидать на сервера. Конфиги обычно представляют собой текстовые файлы в формате jinja. В дальнейшем эти шаблоны рендерятся согласно правилам и раскидываются по серверам.

   5. meta —  описывает кто создал эту роль, автор, лицензии, зависимости, совместимость и т.п. По большей части оно не нужно, это мета данные.

   6. files — в ней можно хранить статичные файлы, бинарники или что-то похожее. Короче это файлы, которые нужно скопировать на целевой хост. Например какие-нибудь экспортеры для prometheus, чтобы не тянуть их с github, либо какой-то другой софт.

   7. tests — логично, храним тесты

   8. vars — тоже самое что и defaults, НО имеет бОльший приоритет. В этой папке можно переопределить переменные, которые указаны в папке defaults.
        >Работает это так: в папке defaults определена переменная swap=10, если переменная переопределена в папке vars и равна swap=20, то будет использоваться swap=20. НО если в папке infra/group_vars эта переменная еще раз переопределена и swap=30, то будет использоваться swap=20 из папки vars.

        > Краткая схема приоритетов от низшего к высшему:

            1. defaults
            2. group_vars
            3. vars
            4. Командная строка, через параметр -e
        > Грубо говоря, забиваем переменную сначала в defaults, а потом переопределяем если нужно в infra/group_vars. Все остальное не используем. 
        
    Основные папки:
      - defaults
      - handlers
      - tasks
      - templates

   > Сейчас роли складываем сразу в проект, но по бест-практикам все эти роли должны находиться в отдельном git репозитории. И лишь по необходимости подключаться в проекты.

   > Не обязательно использовать ansible-galaxy, ты можешь создать ручками нужные тебе папки. Но если пишешь роли не только для себя, лучше делать всё профессионально и правильно.
   
2. оформляем таски

   в common/tasks/main.yml

    ```
    ---
    - name: set timezone to Europe/Moscow
      timezone:
        name: Europe/Moscow
    ```

    > Так как это YML, в начале файла нужно заебенить три чёрточки, чтобы оно валидно распарсилось. Не пропусти момент.

    Что тут происходит:
      1. В name указываем имя таски, чтобы во время выполнения понимать что в данный момент происходит. Можно конечно указать 1234, но привыкай сразу делать нормально.
   
      2. Далее используется модуль timezone, который равен Europe/Moscow

3. подключаем роль к проекту

    в infra/production.yml и infra/stage.yml дописываем 
    ```
    ---
    - hosts: web
      roles:
        - { role: "common" }
    ```

    В hosts указываем для каких групп серверов будут подключены роли, у нас в inventory/production.ini и inventory/stage.ini 


4. выполняем таску для прода
   
    `ansible-playbook -i inventory/production.ini production.yml`

    в результате получили сукесфуле

5. выполняем таску для стейджа
   
    `ansible-playbook -i inventory/stage.ini stage.yml`

    в результате получили сукесфуле